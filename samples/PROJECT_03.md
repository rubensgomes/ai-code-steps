[![Java Version](https://img.shields.io/badge/Java-21-blue.svg

# User Account Microservice

This project is a cloud native microservice that provides RESTful APIs to manage
the creation of user accounts. It provides APIs to create the user account,
confirm the creation of the user account, change the user's account password,
authenticate the user (e.g., sign in), and display the user account information.

## Overview

This is a Java 21 Spring Boot 3.5.4 microservice application that provides
RESTful APIs to
create a user account, confirm the creation of the user account, change the
user's account password, and authenticate the user. The persistence storage for
the microservice should be
implemented in a single table in a MariaDB database.

## API Requirements

The API should be designed to be stateless and should follow RESTful
principles. It should use JSON as the data format for requests and responses.
The API should be secured using JWT (JSON Web Tokens) for authentication and
authorization. The API should also provide proper error handling and return
appropriate HTTP status codes for success and failure scenarios. The API should
be documented using OpenAPI 3.0 specification, and the documentation should be
available in a user-friendly format, such as Swagger UI.

## Set of APIs

### Base URL

http://localhost:8080/api

### API Endpoints

Refer to the [API.md](API.md) file for detailed API documentation.

### Create User Account API

The API to create the user account should provide as inputs a user name, email
and password. It should ensure that the user name and email are unique. Upon
validation the API should store the information provided is stored in a single
table in a MariaDB database. The record created should contain a unique generated
UUID for
the user's id or primary key of that table.

The API should also add a time and date timestamp of when the account was
created. This timestamp should be stored in the same table using the UTC
timezone. The API should also generate and store a random token that will be
used to confirm the creation of the user account. This token should be stored in
the same database table along with the user account information. The token
should be a secure random UUID string that is unique for each user account. The
API should return a response with the user account information, including the
user name, email, user ID, and a message advising the user to confirm the
creation of the account in the user's provided email. The response should also
include a status code indicating the success or failure of the operation.

If the user name or email is not unique, the API should return an error
response with a status code indicating the conflict. If the user account is
successfully created, the API should return a status code indicating success
and the user account information in the response body.

It should also send a confirmation email to the user's provided email address
with a link to confirm the creation of the user account. The link should include
the confirmation token generated by the API. The email should contain a message
informing the user that they need to click the link to confirm their account
creation. The email should be sent asynchronously to avoid blocking the API
response. The email should be sent using a reliable email service provider, such
as SendGrid, Amazon SES, or similar. The email should be sent in a background
thread to ensure that the API response is not delayed. The email should be
formatted in HTML and should include a link that the user can click to confirm
their account creation. The link should point to the Confirm User Account
Creation API, which will be described below.

### Confirm User Account Creation API

The API to confirm the creation of the user account should be called by
clicking a link in the previously sent confirmation email. This API should be a
simple GET API that uses the randomly generated token which was placed there by
the previous Create User Account API implementation. The token should be stored
in the database along with the user account information. When the user clicks
the link, the token is validated and the user account is activated. A time stamp
containing the server UTC timezone time and date should be stored in the
database. This allows future tracking of when the account was activated. Also,
once activated a flag should be set in the database to indicate that the user
account is active. The API should return a response indicating the success or
failure of the operation. If the token is valid and the user account
is successfully activated, the API should return a status code indicating
success and a message indicating that the user account has been successfully
confirmed. If the token is invalid or the user account is already confirmed, the
API should return an error response with a status code indicating the conflict
or bad request.

### Request to Change User Account Password API

The API to request a change of the user's account password should provide as
inputs the user's email. The API should validate that the user exists in the
database. If the user exists, the API should generate a secure random token
and send an email to the user's provided email address with a link to change
the user's account password. The link should include the generated token. The
email should contain a message informing the user that they need to click the
link to change their account password. The email should be sent asynchronously
to avoid blocking the API response. The email should be sent using a reliable
email service provider, such as SendGrid, Amazon SES, or similar. The email
should be sent in a background thread to ensure that the API response is not
delayed. The email should be formatted in HTML and should include a link that
the user can click to change their account password. The link should point to
the Change User Account Password API, which will be described below. If the user
does not exist, the API should return an error response with a status code
indicating the not found error. If the user exists, the API should return a
status code indicating success and a message indicating that the password change
request has been successfully sent. The API should also ensure that the user
has not requested a password change in the last 24 hours to prevent abuse.

### Change User Account Password API

The API to change the user's account password should provide as inputs the
user's email, the new password and the token generated in the previous Request
to Change User Account Password API. The API should validate that the user
exists
in the database and that the new password meets the required security standards.
It should also validate that the token is valid and has not expired. The token
should be stored in the database along with the user account information. The
API should check that the token is not older than 24 hours. If the token is
valid, the API should update the user's password in the database and return a
response indicating the success or failure of the operation. The API should also
ensure that the new password is different from the old password. If the user
does
not exist, the API should return an error response with a status code indicating
the not found error. If the new password does not meet the required security
standards, the API should return an error response with a status code indicating
the bad request error. If the token is invalid or has expired, the API should
return an error response with a status code indicating the unauthorized error.
If the password is successfully changed, the API should return a status code
indicating success and a message indicating that the password has been
successfully
changed.

If the user exists, the API should update the user's password in the database
and return a response indicating the success or failure of the operation. The
API should also ensure that the new password is different from the old password.
If the user does not exist, the API should return an error response with a
status
code indicating the not found error. If the new password does not meet the
required security standards, the API should return an error response with a
status code indicating the bad request error. If the password is successfully
changed, the API should return a status code indicating success and a message
indicating that the password has been successfully changed.

### Authenticate User API

The API to authenticate the user should provide as inputs the user's email and
password. The API should validate that the user exists in the database and that
the provided password matches the stored password. The API should use a secure
password hashing algorithm, such as bcrypt, to compare the provided password
with the stored password. If the user exists and the password is correct, the
API should generate a JWT token and return it in the response. The JWT token
should include the user's ID, email, and any other relevant information. The
API should also set an expiration time for the token, such as 1 hour. The API
should return a response with the JWT token and a status code indicating the
success or failure of the operation. If the user does not exist, the API should
return an error response with a status code indicating the not found error. If
the password is incorrect, the API should return an error response with a status
code indicating the unauthorized error. If the user is successfully
authenticated,
the API should return a status code indicating success and the JWT token in the
response body.

### Display User Account Information API

The API to display the user account information should provide as inputs the
user's email. The API should validate that the user exists in the database. If
the user exists, the API should retrieve the user's account information from the
database and return it in the response. The response should include the user's
ID, name, email, and any other relevant information. The API should return a
response with the user account information and a status code indicating the
success or failure of the operation. If the user does not exist, the API should
return an error response with a status code indicating the not found error. If
the user account information is successfully retrieved, the API should return a
status code indicating success and the user account information in the response
body.

## Prerequisites

- **Java**: 21 or higher (OpenJDK recommended)
- **Gradle**: 8.0+
- **IDE**: IntelliJ IDEA
- **Database**:  MariaDB (latest) / H2 (for development)
- **Docker**: for containerized deployment

## Technology Stack

- **Java**: 21 (LTS)
- **Spring Boot**: 3.5.4
- **Spring Framework**: 6.x
- **Database**: MariaDB/H2
- **Build Tool**: Gradle
- **Testing**: JUnit 5, Mockito, TestContainers
- **Documentation**: SpringDoc OpenAPI 3

## Installation

### Clone Repository

```bash
git clone https://github.com/username/useraccount-ms.git
cd useraccount-ms
```

### Using Gradle

```bash
# Install dependencies
./gradlew build

# Run the application
./gradlew bootRun
```

## Quick Start

```bash
# Start the application (Gradle)
./gradlew bootRun

# Application will be available at:
# http://localhost:8080
```

## Project Structure

```
src/
├── main/
│   ├── java/
│   │   └── com/rubensgomes/useraccount/
│   │       ├── UserAccountApplication.java
│   │       ├── config/
│   │       │   ├── DatabaseConfig.java
│   │       │   └── SecurityConfig.java
│   │       ├── controller/
│   │       │   └── UserAccountController.java
│   │       ├── service/
│   │       │   ├── UserAccountService.java
│   │       │   └── impl/
│   │       │       └── UserAccountServiceImpl.java
│   │       ├── repository/
│   │       │   └── UserAccountRepository.java
│   │       ├── entity/
│   │       │   └── UserAccount.java
│   │       ├── dto/
│   │       │   ├── UserAccountRequest.java
│   │       │   └── UserAccountResponse.java
│   │       └── exception/
│   │           ├── GlobalExceptionHandler.java
│   │           └── UserAccountNotFoundException.java
│   └── resources/
│       ├── application.yml
│       ├── application-dev.yml
│       ├── application-prod.yml
│       ├── db/migration/
│       │   └── V1__Create_user_account_table.sql
│       └── static/
└── test/
    └── java/
        └── com/rubensgomes/useraccount/
            ├── UserAccountApplicationTests.java
            ├── controller/
            │   └── UserAccountControllerTest.java
            ├── service/
            │   └── UserAccountServiceTest.java
            └── integration/
                └── UserIntegrationTest.java
```

## Configuration

### Application Properties

```yaml
# application.yml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  application:
    name: useraccount-ms

  datasource:
    url: jdbc:mysql://localhost:3306/useraccount_db
    username: ${DB_USERNAME:admin}
    password: ${DB_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MariaDBDialect
        format_sql: true

  flyway:
    enabled: true
    locations: classpath:db/migration

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized

logging:
  level:
    com.rubensgomes.useraccountms: INFO
    org.springframework.security: DEBUG
```

### Environment Variables

```bash
# .env.example
DB_USERNAME=rubensgomes
DB_PASSWORD=rubensgomes
# generated JWT secret key from https://jwtsecrets.com/#generator
JWT_SECRET=64cd4443f580731388cd556f4f9fbae4
JWT_EXPIRATION=3600 # 1 hour in seconds
```

## Usage

### API Documentation

Once the application is running, access the API documentation at:

- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **OpenAPI JSON**: http://localhost:8080/v3/api-docs

### Sample API Requests

Refer to the [API.md](API.md) file for detailed API documentation and examples.

### Health Checks

```bash
# Application health
curl http://localhost:8080/actuator/health

# Application info
curl http://localhost:8080/actuator/info
```

## Development

### Running Tests

```bash
# Run all tests
./gradlew test

# Run specific test class
./gradlew test --tests UserAccountServiceTest

# Run integration tests
./gradlew test --tests '*IntegrationTest'
```

### Code Quality

```bash
# Run Checkstyle
./gradlew checkstyleMain checkstyleTest

# Run SpotBugs
./gradlew spotbugsMain spotbugsTest

# Run JaCoCo coverage
./gradlew jacocoTestReport

# Apply code formatting (Spotless)
./gradlew spotlessApply

# Check code formatting
./gradlew spotlessCheck

# Run SpotBugs (Maven)
./mvnw spotbugs:check

# Run JaCoCo coverage (Maven)
./mvnw jacoco:report
```

### Database Migration

```bash
# Run Flyway migrations
./gradlew flywayMigrate

# Check migration status
./gradlew flywayInfo

# Clean database (development only)
./gradlew flywayClean
```

### Building

```bash
# Build JAR
./gradlew build

# Build Docker image
docker build -t useraccount-ms:latest .
```

## Deployment

### Docker

```dockerfile
# Dockerfile
FROM openjdk:21-jdk-slim

WORKDIR /app
COPY build/libs/useraccount-ms-*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

```bash
# Build and run with Docker
docker build -t useraccount-ms .
docker run -p 8080:8080 useraccount-ms
```

### Docker Compose

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_USERNAME=mysql
      - DB_PASSWORD=password
    depends_on:
      - db
  
  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: useraccount_db
      MYSQL_USER: mysql
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    ports:
      - "3306:3306"
```